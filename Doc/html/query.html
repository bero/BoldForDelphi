<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Query - Bold for Delphi Examples</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="page.css">
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="index.html" class="logo-link">
          <div class="logo">
            <span class="logo-bold">Bold</span>
            <span class="logo-sub">for Delphi</span>
          </div>
        </a>
      </div>
      <nav class="nav">
        <div class="nav-section">
          <h3 class="nav-title">Simple Examples</h3>
          <details class="nav-group"><summary>GUI Controls</summary>
            <ul>
              <li><a href="boldimage.html">BoldImage</a></li>
              <li><a href="combobox.html">ComboBox</a></li>
              <li><a href="multilanguage.html">MultiLanguage</a></li>
              <li><a href="renderers.html">Renderers</a></li>
              <li><a href="treeview.html">TreeView</a></li>
            </ul>
          </details>
          <details class="nav-group" open><summary>ObjectSpace</summary>
            <ul>
              <li><a href="association_class.html">Association Class</a></li>
              <li><a href="constraints.html">Constraints</a></li>
              <li><a href="custom_attributes.html">Custom Attributes</a></li>
              <li><a href="derived_attributes.html">Derived Attributes</a></li>
              <li><a href="reverse_derived_attributes.html">Reverse Derived</a></li>
              <li><a href="derived_handle.html">Derived Handle</a></li>
              <li><a href="ocl_variables.html">OCL Variables</a></li>
              <li><a href="optimistic_locking.html">Optimistic Locking</a></li>
              <li><a href="query.html" class="active">Query</a></li>
              <li><a href="sql_handle.html">SQL Handle</a></li>
              <li><a href="transactions.html">Transactions</a></li>
            </ul>
          </details>
          <details class="nav-group"><summary>Persistence</summary>
            <ul>
              <li><a href="createdatabase.html">Create Database</a></li>
              <li><a href="logbridge.html">LogBridge</a></li>
              <li><a href="synchronization.html">Synchronization</a></li>
            </ul>
          </details>
        </div>
        <div class="nav-section">
          <h3 class="nav-title">Demo Examples</h3>
          <ul>
            <li><a href="buildings_owners.html">Buildings &amp; Owners</a></li>
            <li><a href="conway.html">Conway's Game of Life</a></li>
            <li><a href="model_evolution.html">Model Evolution</a></li>
            <li><a href="product_structure.html">Product Structure</a></li>
          </ul>
        </div>
      </nav>
    </aside>

    <main class="main">
      <header class="header">
        <p class="breadcrumb"><a href="index.html">Examples</a> / ObjectSpace</p>
        <h1>Query</h1>
        <p class="subtitle">Control update behavior with queries and subscriptions</p>
      </header>

      <section class="content">
        <div class="card">
          <h2>Overview</h2>
          <p>
            This example demonstrates how to implement different kinds of queries to control
            update behavior in Bold. It shows both subscription-based locking and constraint
            validation using the <code>ReceiveQueryFromOwned</code> framework method.
          </p>
        </div>

        <div class="card">
          <h2>How Queries Work</h2>
          <p>When you try to modify an object, Bold asks the object if the change is allowed:</p>
          <div class="diagram">
            <svg viewBox="0 0 600 300" fill="none" xmlns="http://www.w3.org/2000/svg">
              <!-- Background -->
              <rect width="600" height="300" fill="#1e293b"/>

              <!-- User action -->
              <rect x="30" y="30" width="120" height="50" rx="6" fill="#334155" stroke="#3b82f6" stroke-width="2"/>
              <text x="90" y="50" fill="#e2e8f0" font-size="10" font-weight="bold" text-anchor="middle">User Action</text>
              <text x="90" y="65" fill="#94a3b8" font-size="9" text-anchor="middle">name = "It"</text>

              <!-- Arrow to query -->
              <path d="M150 55 L190 55" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowBlue)"/>

              <!-- ReceiveQueryFromOwned box -->
              <rect x="200" y="20" width="200" height="70" rx="6" fill="#0f172a" stroke="#f59e0b" stroke-width="2"/>
              <text x="300" y="42" fill="#f59e0b" font-size="10" font-weight="bold" text-anchor="middle">ReceiveQueryFromOwned</text>
              <text x="300" y="58" fill="#fcd34d" font-size="9" font-family="monospace" text-anchor="middle">if name = 'It' then</text>
              <text x="300" y="72" fill="#fcd34d" font-size="9" font-family="monospace" text-anchor="middle">  Reject('Reserved!')</text>

              <!-- Decision diamond -->
              <polygon points="300,120 340,150 300,180 260,150" fill="#334155" stroke="#475569" stroke-width="2"/>
              <text x="300" y="154" fill="#e2e8f0" font-size="9" text-anchor="middle">Valid?</text>

              <!-- Arrow from box to diamond -->
              <path d="M300 90 L300 120" stroke="#475569" stroke-width="2"/>

              <!-- Yes path - Allow -->
              <path d="M340 150 L420 150 L420 200" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
              <text x="380" y="140" fill="#22c55e" font-size="9">Yes</text>

              <rect x="370" y="200" width="100" height="50" rx="6" fill="#14532d" stroke="#22c55e" stroke-width="2"/>
              <text x="420" y="222" fill="#22c55e" font-size="10" font-weight="bold" text-anchor="middle">ALLOW</text>
              <text x="420" y="238" fill="#86efac" font-size="9" text-anchor="middle">Change applied</text>

              <!-- No path - Reject -->
              <path d="M260 150 L180 150 L180 200" stroke="#ef4444" stroke-width="2" marker-end="url(#arrowRed)"/>
              <text x="220" y="140" fill="#ef4444" font-size="9">No</text>

              <rect x="130" y="200" width="100" height="50" rx="6" fill="#7f1d1d" stroke="#ef4444" stroke-width="2"/>
              <text x="180" y="222" fill="#ef4444" font-size="10" font-weight="bold" text-anchor="middle">REJECT</text>
              <text x="180" y="238" fill="#fca5a5" font-size="9" text-anchor="middle">Show error</text>

              <!-- Lock subscriber section -->
              <rect x="440" y="20" width="145" height="130" rx="6" fill="#0f172a" stroke="#475569"/>
              <text x="512" y="42" fill="#94a3b8" font-size="10" font-weight="bold" text-anchor="middle">Attribute Locking</text>

              <!-- Unlocked state -->
              <rect x="455" y="55" width="55" height="35" rx="4" fill="#14532d" stroke="#22c55e"/>
              <text x="482" y="70" fill="#22c55e" font-size="8" text-anchor="middle">Unlocked</text>
              <text x="482" y="82" fill="#86efac" font-size="7" text-anchor="middle">Editable</text>

              <!-- Locked state -->
              <rect x="520" y="55" width="55" height="35" rx="4" fill="#7f1d1d" stroke="#ef4444"/>
              <text x="547" y="70" fill="#ef4444" font-size="8" text-anchor="middle">Locked</text>
              <text x="547" y="82" fill="#fca5a5" font-size="7" text-anchor="middle">Read-only</text>

              <!-- Lock icon -->
              <rect x="478" y="100" width="18" height="14" rx="2" fill="#f59e0b"/>
              <path d="M481 100 L481 95 A6 6 0 0 1 493 95 L493 100" stroke="#f59e0b" stroke-width="2" fill="none"/>
              <text x="512" y="112" fill="#94a3b8" font-size="8">TBoldPassthrough</text>
              <text x="512" y="124" fill="#94a3b8" font-size="8">Subscriber</text>

              <!-- Example rules box -->
              <rect x="440" y="160" width="145" height="90" rx="6" fill="#334155" stroke="#475569"/>
              <text x="512" y="180" fill="#94a3b8" font-size="9" font-weight="bold" text-anchor="middle">Example Rules</text>
              <text x="450" y="198" fill="#64748b" font-size="8">• name ≠ empty</text>
              <text x="450" y="212" fill="#64748b" font-size="8">• name ≠ "It"</text>
              <text x="450" y="226" fill="#64748b" font-size="8">• parts.count ≤ 4</text>
              <text x="450" y="240" fill="#64748b" font-size="8">• self ∉ parts</text>

              <!-- Arrow markers -->
              <defs>
                <marker id="arrowBlue" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                  <polygon points="0 0, 8 3, 0 6" fill="#3b82f6"/>
                </marker>
                <marker id="arrowGreen" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                  <polygon points="0 0, 8 3, 0 6" fill="#22c55e"/>
                </marker>
                <marker id="arrowRed" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                  <polygon points="0 0, 8 3, 0 6" fill="#ef4444"/>
                </marker>
              </defs>
            </svg>
          </div>
          <style>
            .diagram { margin: 1.5rem 0; border-radius: 0.5rem; overflow: hidden; }
            .diagram svg { width: 100%; height: auto; display: block; }
          </style>
        </div>

        <div class="card">
          <h2>How to Run</h2>
          <p>Enter <em>Things</em> in the grid using the navigator. Try these scenarios:</p>
          <ol>
            <li><strong>Empty name validation</strong> - Try to save a Thing without a name</li>
            <li><strong>Reserved name</strong> - Try naming a Thing "It"</li>
            <li><strong>Parts limit</strong> - Drag more than 4 Things into the Parts listbox</li>
            <li><strong>Self-reference</strong> - Try to drag a Thing as a Part of itself</li>
            <li><strong>Attribute locking</strong> - Select a Thing, click "Lock Name", then try to edit the name</li>
            <li><strong>Release locks</strong> - Click "Release All" to unlock</li>
          </ol>
        </div>

        <div class="card">
          <h2>Constraints Implemented</h2>
          <table>
            <thead>
              <tr>
                <th>Constraint</th>
                <th>Implementation</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>A Thing may not have more than 4 Parts</td>
                <td><code>ReceiveQueryFromOwned</code></td>
              </tr>
              <tr>
                <td>A Thing may not be a Part of itself</td>
                <td><code>ReceiveQueryFromOwned</code></td>
              </tr>
              <tr>
                <td>A Thing may not be named "It"</td>
                <td><code>ReceiveQueryFromOwned</code></td>
              </tr>
              <tr>
                <td>A Thing may not be saved with empty name</td>
                <td><code>ReceiveQueryFromOwned</code></td>
              </tr>
              <tr>
                <td>Lock individual attribute edits</td>
                <td><code>TBoldPassthroughSubscriber</code></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h2>Implementation Details</h2>

          <h3>TBoldPassthroughSubscriber</h3>
          <p>
            A private <code>LockSubscriber</code> variable prevents updates to specific attributes.
            When you click "Lock Name", the subscriber attaches to the name attribute, blocking
            changes until released.
          </p>

          <h3>ReceiveQueryFromOwned</h3>
          <p>
            The <code>TThing</code> class overrides <code>ReceiveQueryFromOwned</code> to implement
            business rules. This method intercepts proposed changes and can reject them with
            appropriate error messages.
          </p>
        </div>

        <div class="card">
          <h2>Project Files</h2>
          <div class="file-link">
            <a href="../../examples/Delphi/Simple/ObjectSpace/Query/QueryDemoProject.dpr">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              <span>QueryDemoProject.dpr</span>
            </a>
          </div>
          <p class="hint">Location: <code>examples\Delphi\Simple\ObjectSpace\Query\</code></p>
        </div>
      </section>

      <footer class="footer">
      </footer>
    </main>
  </div>
</body>
</html>
